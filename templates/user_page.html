<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
  <title>Biá»ƒu Ä‘á»“ Ä‘iá»‡n nÄƒng</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; text-align:center}
    .stats { display: flex; gap: 20px; margin-bottom: 20px; justify-content: space-between;}
    .stat-box { background: #f2f2f2; padding: 15px; border-radius: 10px; width: 200px; text-align: center; }
    canvas { max-width: 100%; }
    .controls { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Biá»ƒu Ä‘á»“ Ä‘iá»‡n nÄƒng theo giá»</h1>

  <!-- áº¨n room_id Ä‘á»ƒ sá»­ dá»¥ng trong JS -->
  <input type="hidden" id="roomId" value="{{ room_id }}">

  <div class="controls">
    <label for="date">Chá»n ngÃ y: </label>
    <input type="date" id="date" />
    <button onclick="loadChart()">Xem biá»ƒu Ä‘á»“</button>
  </div>

  <div class="stats">
    <div class="stat-box">
      <h3>Äiá»‡n nÄƒng Ä‘Ã£ tiÃªu thá»¥</h3>
      <p id="totalEnergy">-- kWh</p>
    </div>
    <div class="stat-box">
      <h3>Tá»•ng tiá»n</h3>
      <p id="totalCost">-- VND</p>
    </div>
    <div class="stat-box">
      <h3>Äiá»‡n Ã¡p</h3>
      <p id="avgVoltage">-- V</p>
    </div>
    <div class="stat-box">
      <h3>DÃ²ng Ä‘iá»‡n</h3>
      <p id="avgCurrent">-- A</p>
    </div>
    <div class="stat-box">
      <h3>CÃ´ng suáº¥t</h3>
      <p id="avgPW">-- W</p>
    </div>
    <div class="stat-box">
      <h3>Há»‡ sá»‘ cÃ´ng suáº¥t</h3>
      <p id="PF"></p>
    </div>
  </div>
  <p id="selectedDateDisplay"><strong>NgÃ y truy xuáº¥t:</strong> --</p>

  <canvas id="energyChart" height="100"></canvas>

    <script>
    let chart;

    function loadChart() {
      const date = document.getElementById("date").value;
      const room_id = document.getElementById("roomId").value;

      if (!date) return alert("Vui lÃ²ng chá»n ngÃ y!");
      document.getElementById("selectedDateDisplay").innerHTML = `<strong>NgÃ y truy xuáº¥t:</strong> ${date}`;

      fetch("/get_data", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, room_id })
      })
      .then(res => res.json())
      .then(data => {


  // ğŸ‘‰ Cáº­p nháº­t ngÃ y truy xuáº¥t
  document.getElementById("selectedDateDisplay").innerHTML = `<strong>NgÃ y truy xuáº¥t:</strong> ${date}`;

  // ğŸ‘‰ Cáº­p nháº­t sá»‘ liá»‡u thá»‘ng kÃª
  document.getElementById("totalEnergy").innerText = data.total_energy + " kWh";
  document.getElementById("totalCost").innerText = data.total_cost + " VND";
  document.getElementById("avgVoltage").innerText = data.voltage + " V";
  document.getElementById("avgCurrent").innerText = data.current + " A";
  document.getElementById("avgPW").innerText = data.power + " W";
  document.getElementById("PF").innerText = data.pf;
  console.log(data.energy);
  // ğŸ‘‰ Náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u, hiá»ƒn thá»‹ thÃ´ng bÃ¡o vÃ  áº©n biá»ƒu Ä‘á»“
  if (data.energy.length === 0) {
    if (chart) chart.destroy();
    document.getElementById("energyChart").style.display = "none";
    document.getElementById("selectedDateDisplay").innerHTML += `<br><em style="color:red;">KhÃ´ng cÃ³ dá»¯ liá»‡u cho ngÃ y nÃ y.</em>`;
    return alert(data.error);;
  }

  // ğŸ‘‰ Náº¿u cÃ³ dá»¯ liá»‡u, hiá»ƒn thá»‹ biá»ƒu Ä‘á»“
  document.getElementById("energyChart").style.display = "block";

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('energyChart'), {
    type: 'bar',
    data: {
      labels: data.hours,
      datasets: [{
        label: 'Äiá»‡n nÄƒng (kWh)',
        data: data.energy,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "kWh" }
        },
        x: {
          title: { display: true, text: "Giá»" }
        }
      }
    }
  });
});
    }

    // âœ… GÃ¡n ngÃ y hÃ´m nay khi trang táº£i vÃ  tá»± Ä‘á»™ng fetch dá»¯ liá»‡u

    window.onload = function () {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("date").value = today;
    loadChart();
    setInterval(loadChart, 5000);  // âš ï¸ cáº­p nháº­t má»—i 5 giÃ¢y
  };
  </script>

</body>
</html>
